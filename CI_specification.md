### Предварительные сведения ###

* (1) Каждая программа, передаваемая в проверяющую систему, представляется двумя файлами:
 + `source.*`   - исходный код;
 + `make.json`  - строки компиляции (СК).

* (2.1) Автор задачи взаимодействует с проверяющей системой двумя способами:
 + предоставляет пары `source`/`make` всех программных компонентов комплекта материалов задачи (чекера, валидатора и пр.);
 + указывает множество строк компиляции, допустимых автором для решений задачи (*СКДА*).

* (2.2) Подготовка задачи в общем случае происходит независимо от проведения соревнования, поэтому автор задачи не располагает информацией о строках компиляции, которые могут быть выполнены в проверяющей системе (строках компиляции, допустимых системой, *СКДС*).

* (2.3) Автор задачи в условиях отсутствия информации о *СКДС* может исходить из следующих предположений о компиляции программных компонентов комплекта материалов задачи и решений:
 + исходный код может быть скомпилирован любым доступным компилятором указанного языка программирования;
 + исходный код может быть скомпилирован конкретным компилятором;
 + исходный код может быть скомпилирован конкретным компилятором с указанием специальных опций компиляции.

* (3.1) Автор решения взаимодействует с проверяющей системой единственным способом - предоставляя `source`-файл решения задачи и указывая предпочитаемую строку компиляции из списка доступных. Соответствующий `make`-файл составляется проверяющей системой.

* (3.2) Множество строк компиляции, доступных автору решения, определяется множествами *СКДА и СКДС* (в простейшем случае - их пересечением). Поэтому полагается, что решение всегда может быть корректно скомпилировано в проверяющей системе.

### JSON-файлы описаний ###

* (4) Файл `system_make.json` хранится на стороне проверяющей системы и содержит описание множества *СКДС* в показанном ниже формате:

        {
          "L1" : {
            "C11" : "S11",
            "C12" : "S12"
          },
          "L2" : {
            "C21" : "S21",
            "C22" : "S22"
          }
        }

 Здесь *Li* - идентификатор языка программирования, *Cij* - идентификатор  компилятора языка *Li*, *Sij* - строка компиляции по умолчанию для компилятора *Cij*. Пример:

        {
          "C++"    : {
            "GCC"  : "g++ source.cpp -o source.exe",
            "MSVC" : "cl source.cpp"
          },
          "Pascal" : {
            "FPC"  : "fpc source.pas"
          }
        }

* (5.1) Файл `author_make.json` поставляется в составе комплекта материалов задачи и содержит описание множества *СКДА* в показанном ниже формате:

        {
          "C1" : "O1",
          "C2" : "O2"
        }

 Здесь *Ci* - идентификатор компилятора или языка, *Oi* - дополнительные опции для компилятора *Ci:*

 + Если *Ci* - идентификатор компилятора, то предполагается компиляция решений компилятором *Ci*, если он доступен в проверяющей системе; при этом строка *Oi* добавляется к строке компиляции по умолчанию;
 + Если *Ci* - идентификатор языка, то предполагается компиляция решений любым доступным в проверяющей системе компилятором языка *Ci*; при этом строка *Oi* игнорируется.

 В приведённом ниже примере предполагается компиляция решений компилятором GCC с опциями по умолчанию, компилятором MSVC с дополнительной опцией -O2, либо любым доступным компилятором языка Pascal.

        {
          "GCC"    : "",
          "MSVC"   : "-O2",
          "Pascal" : ""
        }

* (5.2) Отсутствие файла `author_make.json` трактуется как отсутствие любых ограничений на компиляцию решений, т. е. предполагается компиляция решения любым доступным в проверяющей системе компилятором соответствующего языка.

* (6.1) Прочие файлы `make.json`, относящиеся к тем или иным программам, полностью аналогичны по своему формату файлу `author_make.json`.

* (6.2) Файлы `make.json`, включённые в комплект материалов задачи, составляются автором задачи. Как следствие, они могут включать любое из предположений, описанных в п. 2.3 (оформленное согласно п. 5.1).

* (6.3) Файлы `make.json`, относящиеся к решению, составляются проверяющей системой (согласно п. 3.1 и 3.2). Как следствие, они содержат единственный идентификатор компилятора без указания опций.

### Работа инфраструктуры компиляции ###

* (7) Основной задачей инфраструктуры компиляции в составе проверяющей системы является анализ файлов описания строк компиляции с вынесением решения о возможности/невозможности компиляции программы в проверяющей системе, а также формирование окончательно конкретизированной строки компиляции в том случае, когда компиляция возможна.

* (8.1) Входными данными для инфраструктуры компиляции является содержимое файлов `make.json`, `author_make.json` и `system_make.json`. Выходные данные записываются в файл `compile.json`.

* (8.2) Если файл `author_make.json` содержит идентификатор языка, присутствующий в файле `system_make.json`, то из последнего извлекаются все строки компиляции, относящиеся к компиляторам указанного языка.

 Если файл `author_make.json` содержит идентификатор компилятора, присутствующий в файле `system_make.json`, то из последнего извлекается соответствующая строка компиляции, после чего к ней добавляются опции, указанные в файле `author_make.json`.

 Все извлечённые на данном этапе строки компиляции составляют временное множество `<allowed>.json`.

 Если файл `author_make.json` отсутствует, то множество `<allowed>.json` содержит все строки компиляции, описанные в файле `system_make.json`.

* (8.3) Если файл `make.json` содержит идентификатор языка, присутствующий в множестве `<allowed>.json`, то из последнего извлекается первая строка компиляции, относящаяся к компилятору указанного языка.

 Если файл `make.json` содержит идентификатор компилятора, присутствующий в множестве `<allowed>.json`, то из последнего извлекается соответствующая строка компиляции, после чего к ней добавляются опции, указанные в файле `make.json`.

 Полученная на данном этапе строка компиляции является окончательно конкретизированной и записывается в файл `compile.json`.

 Отсутствие строки компиляции является признаком невозможности компиляции программы в проверяющей системе.

* (9.1) Для компиляции программного компонента комплекта материалов задачи инфраструктура компиляции обрабатывает файлы `make.json` и `system_make.json`, после чего исполняет полученную окончательно конкретизированную строку компиляции.

* (9.2) Для получения списка строк компиляции, доступных для решений конкретной задачи, инфраструктура компиляции обрабатывает файлы `author_make.json` и `system_make.json`, после чего сохраняет множество `<allowed>.json`.

* (9.3) Для компиляции решения инфраструктура компиляции обрабатывает файлы `make.json`, `author_make.json` и `system_make.json`, после чего исполняет полученную окончательно конкретизированную строку компиляции.